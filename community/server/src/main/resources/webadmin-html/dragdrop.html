<html>

<head>
	<title>Import all the things</title>
	<script src="js/dropzone.js"></script>
	<script src="js/lib/jquery.js"></script>
	<script src="js/lib/jquery.tools.min.js"></script>
	<link rel="stylesheet" type="text/css" href="css/basic.css">
	<link rel="stylesheet" type="text/css" href="css/dropzone.css">

	<script type="text/javascript">
	Dropzone.autoDiscover = false;

	$(document).ready(function() {				
		var lastNodesFile = { "name" : "nodes.csv" };
		var lastRelationshipsFile = { "name" : "relationships.csv" };
		var correlationId = new Date().getTime();

		$("#facebox").overlay({
			top: 260, 
			mask: { color: '#fff', loadSpeed: 200, opacity: 0.9 },
			closeOnClick: true,
			load: false
		});
				
		Dropzone.options.nodes = {
		  paramName: "nodes", 
		  maxFiles: 1,
		  dictDefaultMessage: "Drop nodes file here or click to find file",
		  success: function(file, done) {
			file.previewElement.querySelector("[data-dz-file]").textContent = done.fileType; 			
		  	lastNodesFile.name = file.name;
		  	lastNodesFile.enumFileType = done.enumFileType;
		  },
		  	  
		};

		Dropzone.options.relationships = {
		  paramName: "relationships", 
		  maxFiles: 1,
		  dictDefaultMessage: "Drop relationships file here or click to find file",
		  success: function(file, done) {
		  	file.previewElement.querySelector("[data-dz-file]").textContent = done.fileType;
		    lastRelationshipsFile.name = file.name;
		    lastRelationshipsFile.enumFileType = done.enumFileType;
		  }
		};		
	
		var nodes = new Dropzone("#nodes", { 
			url: "http://localhost:7474/tools/import/nodes?correlationId=" + correlationId,
			addRemoveLinks: true,
		});

		var rels = new Dropzone("#relationships", { 
			url: "http://localhost:7474/tools/import/relationships?correlationId=" + correlationId,
			addRemoveLinks: true, 			
		});

		var pollJob = function(pollingUri){
    		$.get(pollingUri, function(data) {   
        		if(!data.finished) {
        			$("#import-progress").append(".")
        			setTimeout(function() { pollJob(pollingUri); }, 2000);	
        		} else {
        			$("#import-progress").html("Done. Hurrah! We will feed the monkeys to thank them for their hard work");
        			correlationId = new Date().getTime();
        			rels.options.url = "http://localhost:7474/tools/import/relationships?correlationId=" + correlationId;
        			nodes.options.url = "http://localhost:7474/tools/import/nodes?correlationId=" + correlationId;

        			nodes.removeAllFiles();
        			rels.removeAllFiles();        			
        		}        		
    		});
		}

		$("#import-all-the-things").submit(function(e) {
		    $("#import-progress").html("The Neo4j importer monkeys are hard at work...");
		    $("#facebox").overlay().load();

			var uri = "http://localhost:7474/tools/import/incremental";
			uri += "?lastNodesFile=" + lastNodesFile.name;
			uri += "&lastNodesFileType=" + lastNodesFile.enumFileType;
			uri += "&lastRelationshipsFile=" + lastRelationshipsFile.name;
			uri += "&lastRelationshipsFileType=" + lastRelationshipsFile.enumFileType;
			uri += "&correlationId=" + correlationId;

			$.ajax({
				url: uri,
				type: 'POST',
				success: function(response, status, xhr) {					
					pollJob(xhr.getResponseHeader("Location"));
				}
			});
			e.preventDefault();
		});
	});
	</script>
</head>
	<body>
		<h3>Neo4j Web Importer</h3>

		<p>
		To import data into your neo4j database you need to supply two files:
		<ol>
		<li>Nodes - this file should contain a tab delimited set of properties describing your nodes. It should contain a header line and the first column must be 'id' and will be used as an identifier for that node.</li>
		<li>Relationships - this file should contain a tab delimited set of properties describing your nodes. It should contain a header line and the first three columns must be: 

			<ul>
				<li>'from': an 'id' value for the relationship's source node.</li>
				<li>'to': an 'id' value for the relationship's destination node.</li>
				<li>'type': a string value representing the type of the relationship.</li>
			</ul>
		</li>
		</ol>		
		</p>

		<form id="import-all-the-things" action="http://localhost:7474/tools/import" method="POST" enctype="multipart/form-data">
			<div id="nodes" class="dropzone" style="padding: 25px; display: inline-block; width: 50%; height:250px; float:left">
				<div class="fallback">
					<label for="nodes">Nodes:</label>
					<input type="file" name="nodes" id="nodes">
				</div>
			</div>	

			<div id="relationships" class="dropzone"  style="padding: 25px;display: inline-block; width: 50%; height:250px;">
				<div class="fallback">
					<label for="relationships">Relationships:</label>
					<input type="file" name="relationships" id="relationships">
				</div>
			</div>
			<div style="padding-top:10px">
				<input id="process-import" type="submit" name="submit" value="Import Data">
			</div>
			<div id="facebox">
				<h2>Import In Progress y'all</h2>

				<p>Importing your nodes and relationships.</p> 

				<p>Current Status:
					<h4 id="import-progress">The Neo4j importer monkeys are hard at work...</h4>
				</p>
				
			</div>
		</form>

	</body>
</html>
